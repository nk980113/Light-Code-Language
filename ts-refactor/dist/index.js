import{a as o,b as l,c as v}from"./chunk-JIX7GC3Z.js";import{readFile as S,stat as k}from"node:fs/promises";import{extname as $,join as M,dirname as j}from"node:path";import{fileURLToPath as R}from"node:url";import{inspect as V}from"node:util";import{Worker as z}from"node:worker_threads";import N from"node:events";import P from"auto-bind";import{z as b}from"zod";var n=b;function y(p,t,e){let r=p.safeParse(t);return r.success?r:{success:!1,errors:r.error.issues.map(s=>`${[e,...s.path].join(".")}\uFF1A${s.message}`)}}o(y,"wrapZodError");import h from"chalk";var i=class{static makeContent(t=this.prefix,e){return(typeof e=="string"?e.split(`
`):e).map(s=>`${t}${s}`).join(`
`)}config;constructor({logToConsole:t,saveLog:e,interpreterLog:r,detailedError:s}=m.parse({})){this.config={logToConsole:t,saveLog:e,interpreterLog:r,detailedError:s}}log=[];error(t,e){console.error(i.makeContent(`${i.prefix}${t} ${i.errorPrefix}`,e)),process.exit(1)}errors(t,e){console.error(i.makeContent(`${i.prefix}${t} ${i.errorPrefix}`,[...e.map((r,s)=>`${s} ${r}`),"\u7531\u65BC\u4E0A\u8FF0\u932F\u8AA4\uFF0C\u5C07\u81EA\u52D5\u9000\u51FA\u7A0B\u5F0F"])),process.exit(1)}runtimeError(t){this.error("Runtime",t)}},a=i;o(a,"Logger"),l(a,"prefix",h.blue("LCL ")),l(a,"errorPrefix",h.red("ERR "));var m=n.object({logToConsole:n.boolean().default(!0),saveLog:n.boolean().default(!1),interpreterLog:n.boolean().default(!1),detailedError:n.boolean().default(!1)}).partial();var I="ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz12345678901234567890";function w(p,t){return Math.floor(Math.random()*t)+p}o(w,"randomIntInRange");function T(p){return" ".repeat(p).split("").map(()=>I[w(0,I.length)]).join()}o(T,"notExclusiveRandomId");function d(p,t){let e;do e=T(p);while(t.includes(e));return e}o(d,"randomId");var O=j(R(import.meta.url)),u=class{constructor(t,e){this.instance=e;Object.defineProperty(this,"id",{value:t,writable:!1,configurable:!1}),this.run=this.instance.run}static async create(t,e={}){let{id:r,instance:s}=await c.create(t,e);return new u(r,s)}id;run;on(t,e){this.instance.listener.on(t,e)}};o(u,"Interpreter");var g=class{constructor(t,e,r,s){this.mainFilePath=t;this.content=e;this.config=r;this.logger=s;this.listener=new N,this.state={status:"idle"},P(this)}listener;state;static async create(t,e){let r=y(Z,e,"config");r.success||a.prototype.errors("Interpreter Create",r.errors);let s=new a(r.data);try{let f;try{f=await k(t)}catch(C){throw new Error(`\u627E\u4E0D\u5230\u6A94\u6848 ${t}`,{cause:C})}if(!f.isFile())throw new Error(`\u627E\u4E0D\u5230\u6A94\u6848 ${t}`);if($(t)!==".lcl")throw new Error("\u6587\u4EF6\u7684\u526F\u6A94\u540D\u5FC5\u9808\u70BA .lcl")}catch(f){s.error("Interpreter Create",V(f))}let E=await S(t,{encoding:"utf-8"}),x=new g(t,E,e,s);return{id:d(5,Object.keys(this.instances)),instance:x}}run(){return new Promise((t,e)=>{if(this.state.status!=="idle")return e(`\u7121\u6CD5\u57F7\u884C\u72C0\u614B\u4E0D\u70BAidle\u7684\u57F7\u884C\u5668(\u72C0\u614B\uFF1A${this.state.status})`);this.state={status:"pending",onComplete:r=>{r.success?t(r.data):(this.logger.runtimeError("\u57F7\u884C\u6642\u51FA\u73FE\u932F\u8AA4"),this.logger.runtimeError(r.error),e(r.error))},worker:new z(M(O,"worker.js"),{workerData:{}}).on("message",this.listenMessage)}})}listenMessage(t){switch(t.type){case"stop":{this.state.onComplete(t.data),this.state={status:"idle"};break}case"event":{let{event:e}=t;switch(e.name){case"stateChange":this.state={...this.state,status:e.value},this.listener.emit("stateChange",e.value)}break}}}},c=g;o(c,"InternalInterpreter"),l(c,"instances",{});var L=n.object({chunkPerExecution:n.number().positive().finite().default(100),interval:n.number().nonnegative().default(1),maxChunks:n.number().default(1/0),maxCallLength:n.number().positive().default(100),maxVMem:n.number().nonnegative().default(1/0)}).partial(),U=n.object({fsRoot:n.string().default("")}).partial(),Z=L.merge(m).merge(U);export{u as Interpreter,v as Status};
