import{a as s,b as c,c as C}from"./chunk-TXWRQ74U.js";import{readFile as k,stat as $}from"node:fs/promises";import{extname as L,join as M,dirname as R}from"node:path";import{fileURLToPath as z}from"node:url";import{inspect as N}from"node:util";import{Worker as j}from"node:worker_threads";import V from"node:events";import P from"auto-bind";import{z as w}from"zod";var n=w;function E(u,e,t){let r=u.safeParse(e);return r.success?r:{success:!1,errors:r.error.issues.map(o=>`${[t,...o.path].join(".")}\uFF1A${o.message}`)}}s(E,"wrapZodError");import p from"chalk";function h(){}s(h,"noop");var i=class{static makeContent(e=this.prefix,t){return(typeof t=="string"?t.split(`
`):t).map(o=>`${e}${o}`).join(`
`)}config;debug;info;saveLog;log=[];constructor({logToConsole:e,saveLog:t,debugLog:r,detailedError:o}=b.parse({})){this.config={logToConsole:e,saveLog:t,debugLog:r,detailedError:o},e?(this.config.debugLog?this.debug=(l,m)=>{console.log(i.makeContent(`${i.prefix}Debug ${i.levelToStrMap[l]}`,m))}:this.debug=h,this.info=l=>{console.log(l)}):(this.debug=h,this.info=h),this.config.saveLog&&(this.saveLog=l=>{this.log.push(l)})}error(e,t,r=!0){console.error(i.makeContent(`${i.prefix}${e} ${i.errorPrefix}`,t)),r&&process.exit(1)}errors(e,t,r=!0){console.error(i.makeContent(`${i.prefix}${e} ${i.errorPrefix}`,[...t.map((o,l)=>`${l} ${o}`),"\u7531\u65BC\u4E0A\u8FF0\u932F\u8AA4\uFF0C\u5C07\u81EA\u52D5\u9000\u51FA\u7A0B\u5F0F"])),r&&process.exit(1)}runtimeError(e){this.error("Runtime",e,!1)}},a=i;s(a,"Logger"),c(a,"prefix",p.blue("LCL ")),c(a,"errorPrefix",p.red("ERR ")),c(a,"levelToStrMap",{["analyze"]:p.blue("ANALYZE"),["error"]:p.red("ERR"),["exit"]:p.green("EXIT"),["info"]:p.blue("INFO"),["warn"]:p.yellow("WARN")});var b=n.object({logToConsole:n.boolean().default(!0),saveLog:n.boolean().default(!1),debugLog:n.boolean().default(!1),detailedError:n.boolean().default(!1)}).partial();var I="ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz12345678901234567890";function T(u,e){return Math.floor(Math.random()*e)+u}s(T,"randomIntInRange");function S(u){return" ".repeat(u).split("").map(()=>I[T(0,I.length)]).join()}s(S,"notExclusiveRandomId");function y(u,e){let t;do t=S(u);while(e.includes(t));return t}s(y,"randomId");var O=R(z(import.meta.url)),d=class{constructor(e,t){this.instance=t;Object.defineProperty(this,"id",{value:e,writable:!1,configurable:!1}),this.run=this.instance.run}static async create(e,t={}){let{id:r,instance:o}=await f.create(e,t);return new d(r,o)}id;run;on(e,t){this.instance.listener.on(e,t)}};s(d,"Interpreter");var v=class{constructor(e,t,r,o){this.mainFilePath=e;this.content=t;this.config=r;this.logger=o;this.listener=new V,this.state={status:"idle"},P(this)}listener;state;static async create(e,t){let r=E(D,t,"config");r.success||a.prototype.errors("Interpreter Create",r.errors);let o=new a(r.data);try{let g;try{g=await $(e)}catch(x){throw new Error(`\u627E\u4E0D\u5230\u6A94\u6848 ${e}`,{cause:x})}if(!g.isFile())throw new Error(`\u627E\u4E0D\u5230\u6A94\u6848 ${e}`);if(L(e)!==".lcl")throw new Error("\u6587\u4EF6\u7684\u526F\u6A94\u540D\u5FC5\u9808\u70BA .lcl")}catch(g){o.error("Interpreter Create",N(g))}let l=await k(e,{encoding:"utf-8"}),m=new v(e,l,t,o);return{id:y(5,Object.keys(this.instances)),instance:m}}run(){return new Promise((e,t)=>{if(this.state.status!=="idle")return t(`\u7121\u6CD5\u57F7\u884C\u72C0\u614B\u4E0D\u70BAidle\u7684\u57F7\u884C\u5668(\u72C0\u614B\uFF1A${this.state.status})`);this.state={status:"pending",onComplete:r=>{r.success?e(r.data):(this.logger.runtimeError("\u57F7\u884C\u6642\u51FA\u73FE\u932F\u8AA4\uFF1A"),this.logger.runtimeError(r.error),t(r.error))},worker:new j(M(O,"worker.js"),{workerData:{}}).on("message",this.listenMessage)}})}listenMessage(e){switch(e.type){case"stop":{this.state.onComplete(e.data),this.state={status:"idle"};break}case"event":{let{event:t}=e;switch(t.name){case"stateChange":this.state={...this.state,status:t.value},this.listener.emit("stateChange",t.value)}break}case"debug":{this.logger.debug(e.level,e.content);break}case"log":this.logger.info(e.content)}}},f=v;s(f,"InternalInterpreter"),c(f,"instances",{});var W=n.object({chunkPerExecution:n.number().positive().finite().default(100),interval:n.number().nonnegative().default(1),maxChunks:n.number().default(1/0),maxCallLength:n.number().positive().default(100),maxVMem:n.number().nonnegative().default(1/0)}).partial(),A=n.object({fsRoot:n.string().default("")}).partial(),D=W.merge(b).merge(A);export{d as Interpreter,C as Status};
