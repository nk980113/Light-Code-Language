import{a as s,b as u,c as w}from"./chunk-TXWRQ74U.js";import{readFile as $,stat as M}from"node:fs/promises";import{extname as R,join as z,dirname as N}from"node:path";import{fileURLToPath as j}from"node:url";import{inspect as L}from"node:util";import{Worker as V}from"node:worker_threads";import P from"node:events";import O from"auto-bind";import{z as T}from"zod";var n=T;function v(l,t,e){let r=l.safeParse(t);return r.success?r:{success:!1,errors:r.error.issues.map(o=>`${[e,...o.path].join(".")}\uFF1A${o.message}`)}}s(v,"wrapZodError");import p from"chalk";function I(){}s(I,"noop");var i=class{static makeContent(t=this.prefix,e){return(typeof e=="string"?e.split(`
`):e).map(o=>`${t}${o}`).join(`
`)}config;debug;info;constructor({logToConsole:t,saveLog:e,interpreterLog:r,detailedError:o}=h.parse({})){this.config={logToConsole:t,saveLog:e,interpreterLog:r,detailedError:o},t?(this.debug=s(function(c,E){console.log(i.makeContent(`${i.prefix}Debug ${i.levelToStrMap[c]}`,E))},"debug"),this.info=s(function(c){console.log(c)},"info")):(this.debug=I,this.info=I)}log=[];error(t,e){console.error(i.makeContent(`${i.prefix}${t} ${i.errorPrefix}`,e)),process.exit(1)}errors(t,e){console.error(i.makeContent(`${i.prefix}${t} ${i.errorPrefix}`,[...e.map((r,o)=>`${o} ${r}`),"\u7531\u65BC\u4E0A\u8FF0\u932F\u8AA4\uFF0C\u5C07\u81EA\u52D5\u9000\u51FA\u7A0B\u5F0F"])),process.exit(1)}runtimeError(t){this.error("Runtime",t)}},a=i;s(a,"Logger"),u(a,"prefix",p.blue("LCL ")),u(a,"errorPrefix",p.red("ERR ")),u(a,"levelToStrMap",{["analyze"]:p.blue("ANALYZE"),["error"]:p.red("ERR"),["exit"]:p.green("EXIT"),["info"]:p.blue("INFO"),["warn"]:p.yellow("WARN")});var h=n.object({logToConsole:n.boolean().default(!0),saveLog:n.boolean().default(!1),interpreterLog:n.boolean().default(!1),detailedError:n.boolean().default(!1)}).partial();var x="ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz12345678901234567890";function S(l,t){return Math.floor(Math.random()*t)+l}s(S,"randomIntInRange");function k(l){return" ".repeat(l).split("").map(()=>x[S(0,x.length)]).join()}s(k,"notExclusiveRandomId");function y(l,t){let e;do e=k(l);while(t.includes(e));return e}s(y,"randomId");var W=N(j(import.meta.url)),d=class{constructor(t,e){this.instance=e;Object.defineProperty(this,"id",{value:t,writable:!1,configurable:!1}),this.run=this.instance.run}static async create(t,e={}){let{id:r,instance:o}=await f.create(t,e);return new d(r,o)}id;run;on(t,e){this.instance.listener.on(t,e)}};s(d,"Interpreter");var b=class{constructor(t,e,r,o){this.mainFilePath=t;this.content=e;this.config=r;this.logger=o;this.listener=new P,this.state={status:"idle"},O(this)}listener;state;static async create(t,e){let r=v(Z,e,"config");r.success||a.prototype.errors("Interpreter Create",r.errors);let o=new a(r.data);try{let m;try{m=await M(t)}catch(C){throw new Error(`\u627E\u4E0D\u5230\u6A94\u6848 ${t}`,{cause:C})}if(!m.isFile())throw new Error(`\u627E\u4E0D\u5230\u6A94\u6848 ${t}`);if(R(t)!==".lcl")throw new Error("\u6587\u4EF6\u7684\u526F\u6A94\u540D\u5FC5\u9808\u70BA .lcl")}catch(m){o.error("Interpreter Create",L(m))}let g=await $(t,{encoding:"utf-8"}),c=new b(t,g,e,o);return{id:y(5,Object.keys(this.instances)),instance:c}}run(){return new Promise((t,e)=>{if(this.state.status!=="idle")return e(`\u7121\u6CD5\u57F7\u884C\u72C0\u614B\u4E0D\u70BAidle\u7684\u57F7\u884C\u5668(\u72C0\u614B\uFF1A${this.state.status})`);this.state={status:"pending",onComplete:r=>{r.success?t(r.data):(this.logger.runtimeError("\u57F7\u884C\u6642\u51FA\u73FE\u932F\u8AA4"),this.logger.runtimeError(r.error),e(r.error))},worker:new V(z(W,"worker.js"),{workerData:{}}).on("message",this.listenMessage)}})}listenMessage(t){switch(t.type){case"stop":{this.state.onComplete(t.data),this.state={status:"idle"};break}case"event":{let{event:e}=t;switch(e.name){case"stateChange":this.state={...this.state,status:e.value},this.listener.emit("stateChange",e.value)}break}case"debug":{this.logger.debug(t.level,t.content);break}case"log":this.logger.info(t.content)}}},f=b;s(f,"InternalInterpreter"),u(f,"instances",{});var A=n.object({chunkPerExecution:n.number().positive().finite().default(100),interval:n.number().nonnegative().default(1),maxChunks:n.number().default(1/0),maxCallLength:n.number().positive().default(100),maxVMem:n.number().nonnegative().default(1/0)}).partial(),D=n.object({fsRoot:n.string().default("")}).partial(),Z=A.merge(h).merge(D);export{d as Interpreter,w as Status};
