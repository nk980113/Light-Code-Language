import{a as s,b as l,c as v}from"./chunk-P4LMIXHA.js";import{readFile as M,stat as $}from"node:fs/promises";import{extname as z,join as j,dirname as R}from"node:path";import{fileURLToPath as V}from"node:url";import{inspect as P}from"node:util";import{Worker as N}from"node:worker_threads";import O from"node:events";import W from"auto-bind";import b from"i18next";import{z as g}from"zod";import{zodI18nMap as w}from"zod-i18n-map";import T from"zod-i18n-map/locales/zh-TW/zod.json"assert{type:"json"};b.init({lng:"zh-TW",resources:{"zh-TW":{zod:T}}});g.setErrorMap(w);var n=g;function h(p,t,e){let r=p.safeParse(t);return r.success?r:{success:!1,errors:r.error.issues.map(o=>`${[e,...o.path].join(".")}\uFF1A${o.message}`)}}s(h,"wrapZodError");import y from"chalk";var i=class{static makeContent(t=this.prefix,e){return(typeof e=="string"?e.split(`
`):e).map(o=>`${t}${o}`).join(`
`)}config;constructor({logToConsole:t,saveLog:e,interpreterLog:r,detailedError:o}=m.parse({})){this.config={logToConsole:t,saveLog:e,interpreterLog:r,detailedError:o}}log=[];error(t,e){console.error(i.makeContent(`${i.prefix}${t} ${i.errorPrefix}`,e)),process.exit(1)}errors(t,e){console.error(i.makeContent(`${i.prefix}${t} ${i.errorPrefix}`,[...e.map((r,o)=>`${o} ${r}`),"\u7531\u65BC\u4E0A\u8FF0\u932F\u8AA4\uFF0C\u5C07\u81EA\u52D5\u9000\u51FA\u7A0B\u5F0F"])),process.exit(1)}runtimeError(t){this.error("Runtime",t)}},a=i;s(a,"Logger"),l(a,"prefix",y.blue("LCL ")),l(a,"errorPrefix",y.red("ERR "));var m=n.object({logToConsole:n.boolean().default(!0),saveLog:n.boolean().default(!1),interpreterLog:n.boolean().default(!1),detailedError:n.boolean().default(!1)}).partial();var I="ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz12345678901234567890";function k(p,t){return Math.floor(Math.random()*t)+p}s(k,"randomIntInRange");function S(p){return" ".repeat(p).split("").map(()=>I[k(0,I.length)]).join()}s(S,"notExclusiveRandomId");function f(p,t){let e;do e=S(p);while(t.includes(e));return e}s(f,"randomId");var L=R(V(import.meta.url)),c=class{constructor(t,e){this.instance=e;Object.defineProperty(this,"id",{value:t,writable:!1,configurable:!1}),this.run=this.instance.run}static async create(t,e={}){let{id:r,instance:o}=await u.create(t,e);return new c(r,o)}id;run;on(t,e){this.instance.listener.on(t,e)}};s(c,"Interpreter");var d=class{constructor(t,e,r,o){this.filePath=t;this.content=e;this.config=r;this.logger=o;this.listener=new O,this.state={status:"idle"},W(this)}listener;state;static async create(t,e){let r=h(F,e,"config");r.success||a.prototype.errors("Interpreter Create",r.errors);let o=new a(r.data);try{if(!(await $(t)).isFile())throw new Error(`\u627E\u4E0D\u5230\u6A94\u6848 ${t}`);if(z(t)!==".lcl")throw new Error("\u6587\u4EF6\u7684\u526F\u6A94\u540D\u5FC5\u9808\u70BA .lcl")}catch(E){o.error("Interpreter Create",P(E))}let x=await M(t,{encoding:"utf-8"}),C=new d(t,x,e,o);return{id:f(5,Object.keys(this.instances)),instance:C}}run(){return new Promise((t,e)=>{if(this.state.status!=="idle")return e(`\u7121\u6CD5\u57F7\u884C\u72C0\u614B\u4E0D\u70BAidle\u7684\u57F7\u884C\u5668(\u72C0\u614B\uFF1A${this.state.status})`);this.state={status:"pending",onComplete:r=>{r.success?t(r.data):(this.logger.runtimeError("\u57F7\u884C\u6642\u51FA\u73FE\u932F\u8AA4"),this.logger.runtimeError(r.error),e(r.error))},worker:new N(j(L,"worker.js"),{workerData:{}}).on("message",this.listenMessage)}})}listenMessage(t){switch(t.type){case"stop":{this.state.onComplete(t.data),this.state={status:"idle"};break}case"event":{let{event:e}=t;switch(e.name){case"stateChange":this.state={...this.state,status:e.value},this.listener.emit("stateChange",e.value)}break}}}},u=d;s(u,"InternalInterpreter"),l(u,"instances",{});var U=n.object({chunkPerExecution:n.number().positive().finite().default(100),interval:n.number().nonnegative().default(1),maxChunks:n.number().default(1/0),maxCallLength:n.number().positive().default(100),maxVMem:n.number().nonnegative().default(1/0)}).partial(),Z=n.object({fsRoot:n.string().default("")}).partial(),F=U.merge(m).merge(Z);export{c as Interpreter,v as Status};
